<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Startup<sub>Progress</sub></title>
<!-- 2013-06-19 Wed 09:08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Startup<sub>Progress</sub></h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Purpose</a></li>
<li><a href="#sec-2">2. Read</a>
<ul>
<li><a href="#sec-2-1">2.1. JRuby Hacking Guide by nahi</a></li>
<li><a href="#sec-2-2">2.2. Copy of JRuby Source Code Reading Guide by nahi</a></li>
<li><a href="#sec-2-3">2.3. Ruboto Startup by donV</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Conclusion</a>
<ul>
<li><a href="#sec-3-1">3.1. Ruboto</a></li>
<li><a href="#sec-3-2">3.2. JRuby</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1. org.jruby.*</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Purpose</h2>
<div class="outline-text-2" id="text-1">
<p>
Figure out Ruboto startup &amp; JRuby initialization on Dalvik
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Read</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> <a href="http://prezi.com/tsuouxb3z4ln/jruby-hacking-guide/">JRuby Hacking Guide by nahi</a></h3>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> <a href="http://prezi.com/n7jlwvldnfyu/copy-of-jruby-source-code-reading-guide/">Copy of JRuby Source Code Reading Guide by nahi</a></h3>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> <a href="https://github.com/ruboto/ruboto/wiki/Ruboto-startup">Ruboto Startup by donV</a></h3>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Conclusion</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Ruboto</h3>
<div class="outline-text-3" id="text-3-1">
<p>
LauncherActivity -&gt; EntryPointActivity -&gt; RubotoActivity -&gt; android.app.Activity <br/>
</p>

<p>
JRuby is initialized in the EntryPointActivity class. <br/>
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> JRuby</h3>
<div class="outline-text-3" id="text-3-2">
</div><div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> org.jruby.*</h4>
<div class="outline-text-4" id="text-3-2-1">
</div><ol class="org-ol"><li>Main<br/><div class="outline-text-5" id="text-3-2-1-1">
<p>
Create JRuby instance, Entry
</p>
<div class="org-src-container">

<pre class="src src-java">    <span style="color: #00ffff;">public</span> <span style="color: #00ffff;">static</span> <span style="color: #98fb98;">void</span> <span style="color: #87cefa;">main</span>(<span style="color: #98fb98;">String</span>[] <span style="color: #eedd82;">args</span>) {
        doGCJCheck();

        <span style="color: #98fb98;">Main</span> <span style="color: #eedd82;">main</span>;

        <span style="color: #00ffff;">if</span> (<span style="color: #7fffd4;">DripMain</span>.DRIP_RUNTIME != <span style="color: #7fffd4;">null</span>) {
            main = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">Main</span>(<span style="color: #7fffd4;">DripMain</span>.DRIP_CONFIG, <span style="color: #7fffd4;">true</span>);
        } <span style="color: #00ffff;">else</span> {
            main = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">Main</span>(<span style="color: #7fffd4;">true</span>);
        }

        <span style="color: #00ffff;">try</span> {
            <span style="color: #98fb98;">Status</span> <span style="color: #eedd82;">status</span> = main.run(args);
            <span style="color: #00ffff;">if</span> (status.isExit()) {
                System.exit(status.getStatus());
            }
        } <span style="color: #00ffff;">catch</span> (<span style="color: #98fb98;">RaiseException</span> <span style="color: #eedd82;">rj</span>) {
            System.exit(handleRaiseException(rj));
        } <span style="color: #00ffff;">catch</span> (<span style="color: #98fb98;">Throwable</span> <span style="color: #eedd82;">t</span>) {
            <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">print out as a nice Ruby backtrace</span>
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
        }
    }

    <span style="color: #00ffff;">public</span> <span style="color: #98fb98;">Status</span> <span style="color: #87cefa;">run</span>(<span style="color: #98fb98;">String</span>[] <span style="color: #eedd82;">args</span>) {
        <span style="color: #00ffff;">try</span> {
            config.processArguments(args);
            <span style="color: #00ffff;">return</span> internalRun(); \\Here a JRuby VM is started
        } <span style="color: #00ffff;">catch</span> (<span style="color: #98fb98;">MainExitException</span> <span style="color: #eedd82;">mee</span>) {
            <span style="color: #00ffff;">return</span> handleMainExit(mee);
        } <span style="color: #00ffff;">catch</span> (<span style="color: #98fb98;">OutOfMemoryError</span> <span style="color: #eedd82;">oome</span>) {
            <span style="color: #00ffff;">return</span> handleOutOfMemory(oome);
        }
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
}

    <span style="color: #00ffff;">private</span> <span style="color: #98fb98;">Status</span> <span style="color: #87cefa;">internalRun</span>() {
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...        </span>
        doProcessArguments(in);
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...        </span>
        <span style="color: #98fb98;">Ruby</span> <span style="color: #eedd82;">runtime</span>;
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
    }
</pre>
</div>
</div>
</li>

<li>Ruby<br/><div class="outline-text-5" id="text-3-2-1-2">
<p>
Run JRuby VM and evaluate scripts
</p>
<ul class="org-ul">
<li>evaluateScript
</li>
</ul>
<div class="org-src-container">

<pre class="src src-java">    <span style="color: #00ffff;">public</span> <span style="color: #98fb98;">IRubyObject</span> <span style="color: #87cefa;">evalScriptlet</span>(<span style="color: #98fb98;">String</span> <span style="color: #eedd82;">script</span>, <span style="color: #98fb98;">DynamicScope</span> <span style="color: #eedd82;">scope</span>) {
        <span style="color: #98fb98;">ThreadContext</span> <span style="color: #eedd82;">context</span> = getCurrentContext();
        <span style="color: #98fb98;">Node</span> <span style="color: #eedd82;">node</span> = parseEval(script, <span style="color: #ffa07a;">"&lt;script&gt;"</span>, scope, 0);

        <span style="color: #00ffff;">try</span> {
            context.preEvalScriptlet(scope);
            <span style="color: #00ffff;">return</span> <span style="color: #7fffd4;">ASTInterpreter</span>.INTERPRET_ROOT(<span style="color: #00ffff;">this</span>, context, node, context.getFrameSelf(), <span style="color: #7fffd4;">Block</span>.NULL_BLOCK);
        } <span style="color: #00ffff;">catch</span> (<span style="color: #7fffd4;">JumpException</span>.<span style="color: #98fb98;">ReturnJump</span> <span style="color: #eedd82;">rj</span>) {
            <span style="color: #00ffff;">throw</span> newLocalJumpError(<span style="color: #7fffd4;">RubyLocalJumpError</span>.<span style="color: #7fffd4;">Reason</span>.RETURN, (<span style="color: #98fb98;">IRubyObject</span>)rj.getValue(), <span style="color: #ffa07a;">"unexpected return"</span>);
        } <span style="color: #00ffff;">catch</span> (<span style="color: #7fffd4;">JumpException</span>.<span style="color: #98fb98;">BreakJump</span> <span style="color: #eedd82;">bj</span>) {
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
        }
    }
</pre>
</div>


<ul class="org-ul">
<li>executeScript
</li>
</ul>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #00ffff;">public</span> <span style="color: #98fb98;">IRubyObject</span> <span style="color: #87cefa;">executeScript</span>(<span style="color: #98fb98;">String</span> <span style="color: #eedd82;">script</span>, <span style="color: #98fb98;">String</span> <span style="color: #eedd82;">filename</span>) {
    <span style="color: #98fb98;">byte</span>[] <span style="color: #eedd82;">bytes</span> = script.getBytes();

    <span style="color: #98fb98;">Node</span> <span style="color: #eedd82;">node</span> = parseInline(<span style="color: #00ffff;">new</span> <span style="color: #98fb98;">ByteArrayInputStream</span>(bytes), filename, <span style="color: #7fffd4;">null</span>);
    <span style="color: #98fb98;">ThreadContext</span> <span style="color: #eedd82;">context</span> = getCurrentContext();

    <span style="color: #98fb98;">String</span> <span style="color: #eedd82;">oldFile</span> = context.getFile();
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">oldLine</span> = context.getLine();
    <span style="color: #00ffff;">try</span> {
        context.setFileAndLine(node.getPosition());
        <span style="color: #00ffff;">return</span> runInterpreter(node);
    } <span style="color: #00ffff;">finally</span> {
        context.setFileAndLine(oldFile, oldLine);
    }
}
</pre>
</div>
</div>
</li>
<li>How a JRuby VM started<br/><ol class="org-ol"><li>The object constructor<br/><div class="outline-text-6" id="text-3-2-1-3-1">
<p>
Set up a new JRuby runtime according to the properties of a specific RubyInstanceConfig object. I only leave lines with object initializing below.
</p>
<div class="org-src-container">

<pre class="src src-java">    <span style="color: #00ffff;">private</span> Ruby(<span style="color: #98fb98;">RubyInstanceConfig</span> <span style="color: #eedd82;">config</span>) {
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
        <span style="color: #00ffff;">this</span>.threadService      = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">ThreadService</span>(<span style="color: #00ffff;">this</span>);
        <span style="color: #00ffff;">if</span>(config.isSamplingEnabled()) {
            <span style="color: #7fffd4;">org</span>.<span style="color: #7fffd4;">jruby</span>.<span style="color: #7fffd4;">util</span>.SimpleSampler.registerThreadContext(threadService.getCurrentContext());
        }

        getJRubyClassLoader(); <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">force JRubyClassLoader to init if possible</span>

        <span style="color: #00ffff;">if</span> (config.getCompileMode() == <span style="color: #7fffd4;">CompileMode</span>.OFFIR ||
                config.getCompileMode() == <span style="color: #7fffd4;">CompileMode</span>.FORCEIR) {
            <span style="color: #00ffff;">this</span>.staticScopeFactory = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">IRStaticScopeFactory</span>(<span style="color: #00ffff;">this</span>);
        } <span style="color: #00ffff;">else</span> {
            <span style="color: #00ffff;">this</span>.staticScopeFactory = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">StaticScopeFactory</span>(<span style="color: #00ffff;">this</span>);
        }

        <span style="color: #00ffff;">this</span>.beanManager        = BeanManagerFactory.create(<span style="color: #00ffff;">this</span>, config.isManagementEnabled());
        <span style="color: #00ffff;">this</span>.jitCompiler        = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">JITCompiler</span>(<span style="color: #00ffff;">this</span>);
        <span style="color: #00ffff;">this</span>.parserStats        = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">ParserStats</span>(<span style="color: #00ffff;">this</span>);

<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...Random </span>

        <span style="color: #00ffff;">this</span>.beanManager.register(<span style="color: #00ffff;">new</span> <span style="color: #98fb98;">Config</span>(<span style="color: #00ffff;">this</span>));
        <span style="color: #00ffff;">this</span>.beanManager.register(parserStats);
        <span style="color: #00ffff;">this</span>.beanManager.register(<span style="color: #00ffff;">new</span> <span style="color: #98fb98;">ClassCache</span>(<span style="color: #00ffff;">this</span>));
        <span style="color: #00ffff;">this</span>.beanManager.register(<span style="color: #00ffff;">new</span> <span style="color: #7fffd4;">org</span>.<span style="color: #7fffd4;">jruby</span>.<span style="color: #7fffd4;">management</span>.<span style="color: #98fb98;">Runtime</span>(<span style="color: #00ffff;">this</span>));

        <span style="color: #00ffff;">this</span>.runtimeCache = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">RuntimeCache</span>();
        runtimeCache.initMethodCache(<span style="color: #7fffd4;">ClassIndex</span>.MAX_CLASSES * MethodNames.values().length - 1);

        constantInvalidator = OptoFactory.newConstantInvalidator();
        checkpointInvalidator = OptoFactory.newConstantInvalidator();
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
        reinitialize(<span style="color: #7fffd4;">false</span>);
    }
</pre>
</div>
</div>
</li>
<li>init()<br/><div class="outline-text-6" id="text-3-2-1-3-2">
<p>
It seems that core classes and libraries are loaded from here. Maybe this could be a key entry for speeding up JRuby on Dalvik.
</p>

<div class="org-src-container">

<pre class="src src-java">    <span style="color: #00ffff;">private</span> <span style="color: #98fb98;">void</span> <span style="color: #87cefa;">init</span>() {
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Construct key services</span>
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">...</span>
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">initialize the root of the class hierarchy completely</span>
        initRoot();
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Set up the main thread in thread service</span>
        threadService.initMainThread();
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Get the main threadcontext (gets constructed for us)</span>
        <span style="color: #98fb98;">ThreadContext</span> <span style="color: #eedd82;">tc</span> = getCurrentContext();
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Construct the top-level execution frame and scope for the main thread</span>
        tc.prepareTopLevel(objectClass, topSelf);
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Initialize all the core classes</span>
        bootstrap();
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">set up defined messages</span>
        initDefinedMessages();
        irManager = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">IRManager</span>();
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Initialize the "dummy" class used as a marker</span>
        dummyClass = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">RubyClass</span>(<span style="color: #00ffff;">this</span>, classClass);
        dummyClass.freeze(tc);

        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Create global constants and variables</span>
        RubyGlobal.createGlobals(tc, <span style="color: #00ffff;">this</span>);

        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Prepare LoadService and load path</span>
        getLoadService().init(config.getLoadPaths());

        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">initialize builtin libraries</span>
        initBuiltins();

        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">load JRuby internals, which loads Java support</span>
        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">if we can't use reflection, 'jruby' and 'java' won't work; no load.</span>
        <span style="color: #98fb98;">boolean</span> <span style="color: #eedd82;">reflectionWorks</span>;
        <span style="color: #00ffff;">try</span> {
            ClassLoader.<span style="color: #00ffff;">class</span>.getDeclaredMethod(<span style="color: #ffa07a;">"getResourceAsStream"</span>, String.<span style="color: #00ffff;">class</span>);
            reflectionWorks = <span style="color: #7fffd4;">true</span>;
        } <span style="color: #00ffff;">catch</span> (<span style="color: #98fb98;">Exception</span> <span style="color: #eedd82;">e</span>) {
            reflectionWorks = <span style="color: #7fffd4;">false</span>;
        }

        <span style="color: #00ffff;">if</span> (!<span style="color: #7fffd4;">RubyInstanceConfig</span>.DEBUG_PARSER &amp;&amp; reflectionWorks) {
            loadService.require(<span style="color: #ffa07a;">"jruby"</span>);
        }

        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">out of base boot mode</span>
        booting = <span style="color: #7fffd4;">false</span>;

        <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">init Ruby-based kernel</span>
        initRubyKernel();
<span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">..        </span>
    }
</pre>
</div>

<p>
We can see that JRuby loads all core classes and builtin libs by invoking <code>bootstrap()</code> <code>initBuiltins()</code>
</p>
</div>

<ol class="org-ol"><li>bootstrap()<br/><div class="outline-text-7" id="text-3-2-1-3-2-1">
<p>
It loads all ruby core classes, so we can't try to reduce its size.
</p>
</div>
</li>

<li>initBuiltins()<br/><div class="outline-text-7" id="text-3-2-1-3-2-2">
<p>
When we go into the codes of <code>initBuiltins()</code>, we can find that JRuby loads quite a lot of ext libraries. Maybe there's something we can do with it.
</p>
<div class="org-src-container">

<pre class="src src-java">addLazyBuiltin(<span style="color: #ffa07a;">"java.rb"</span>, <span style="color: #ffa07a;">"java"</span>, <span style="color: #ffa07a;">"org.jruby.javasupport.Java"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"jruby.rb"</span>, <span style="color: #ffa07a;">"jruby"</span>, <span style="color: #ffa07a;">"org.jruby.ext.jruby.JRubyLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"jruby/util.rb"</span>, <span style="color: #ffa07a;">"jruby/util"</span>, <span style="color: #ffa07a;">"org.jruby.ext.jruby.JRubyUtilLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"jruby/type.rb"</span>, <span style="color: #ffa07a;">"jruby/type"</span>, <span style="color: #ffa07a;">"org.jruby.ext.jruby.JRubyTypeLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"iconv.jar"</span>, <span style="color: #ffa07a;">"iconv"</span>, <span style="color: #ffa07a;">"org.jruby.ext.iconv.IConvLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"nkf.jar"</span>, <span style="color: #ffa07a;">"nkf"</span>, <span style="color: #ffa07a;">"org.jruby.ext.nkf.NKFLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"stringio.jar"</span>, <span style="color: #ffa07a;">"stringio"</span>, <span style="color: #ffa07a;">"org.jruby.ext.stringio.StringIOLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"strscan.jar"</span>, <span style="color: #ffa07a;">"strscan"</span>, <span style="color: #ffa07a;">"org.jruby.ext.strscan.StringScannerLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"zlib.jar"</span>, <span style="color: #ffa07a;">"zlib"</span>, <span style="color: #ffa07a;">"org.jruby.ext.zlib.ZlibLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"enumerator.jar"</span>, <span style="color: #ffa07a;">"enumerator"</span>, <span style="color: #ffa07a;">"org.jruby.ext.enumerator.EnumeratorLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"readline.jar"</span>, <span style="color: #ffa07a;">"readline"</span>, <span style="color: #ffa07a;">"org.jruby.ext.readline.ReadlineService"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"thread.jar"</span>, <span style="color: #ffa07a;">"thread"</span>, <span style="color: #ffa07a;">"org.jruby.ext.thread.ThreadLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"thread.rb"</span>, <span style="color: #ffa07a;">"thread"</span>, <span style="color: #ffa07a;">"org.jruby.ext.thread.ThreadLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"digest.jar"</span>, <span style="color: #ffa07a;">"digest.so"</span>, <span style="color: #ffa07a;">"org.jruby.ext.digest.DigestLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"digest/md5.jar"</span>, <span style="color: #ffa07a;">"digest/md5"</span>, <span style="color: #ffa07a;">"org.jruby.ext.digest.MD5"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"digest/rmd160.jar"</span>, <span style="color: #ffa07a;">"digest/rmd160"</span>, <span style="color: #ffa07a;">"org.jruby.ext.digest.RMD160"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"digest/sha1.jar"</span>, <span style="color: #ffa07a;">"digest/sha1"</span>, <span style="color: #ffa07a;">"org.jruby.ext.digest.SHA1"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"digest/sha2.jar"</span>, <span style="color: #ffa07a;">"digest/sha2"</span>, <span style="color: #ffa07a;">"org.jruby.ext.digest.SHA2"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"bigdecimal.jar"</span>, <span style="color: #ffa07a;">"bigdecimal"</span>, <span style="color: #ffa07a;">"org.jruby.ext.bigdecimal.BigDecimalLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"io/wait.jar"</span>, <span style="color: #ffa07a;">"io/wait"</span>, <span style="color: #ffa07a;">"org.jruby.ext.io.wait.IOWaitLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"etc.jar"</span>, <span style="color: #ffa07a;">"etc"</span>, <span style="color: #ffa07a;">"org.jruby.ext.etc.EtcLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"weakref.rb"</span>, <span style="color: #ffa07a;">"weakref"</span>, <span style="color: #ffa07a;">"org.jruby.ext.weakref.WeakRefLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"delegate_internal.jar"</span>, <span style="color: #ffa07a;">"delegate_internal"</span>, <span style="color: #ffa07a;">"org.jruby.ext.delegate.DelegateLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"timeout.rb"</span>, <span style="color: #ffa07a;">"timeout"</span>, <span style="color: #ffa07a;">"org.jruby.ext.timeout.Timeout"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"ripper.jar"</span>, <span style="color: #ffa07a;">"ripper"</span>, <span style="color: #ffa07a;">"org.jruby.ext.ripper.RipperLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"socket.jar"</span>, <span style="color: #ffa07a;">"socket"</span>, <span style="color: #ffa07a;">"org.jruby.ext.socket.SocketLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"rbconfig.rb"</span>, <span style="color: #ffa07a;">"rbconfig"</span>, <span style="color: #ffa07a;">"org.jruby.ext.rbconfig.RbConfigLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"jruby/serialization.rb"</span>, <span style="color: #ffa07a;">"serialization"</span>, <span style="color: #ffa07a;">"org.jruby.ext.jruby.JRubySerializationLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"ffi-internal.jar"</span>, <span style="color: #ffa07a;">"ffi-internal"</span>, <span style="color: #ffa07a;">"org.jruby.ext.ffi.FFIService"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"tempfile.jar"</span>, <span style="color: #ffa07a;">"tempfile"</span>, <span style="color: #ffa07a;">"org.jruby.ext.tempfile.TempfileLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"fcntl.rb"</span>, <span style="color: #ffa07a;">"fcntl"</span>, <span style="color: #ffa07a;">"org.jruby.ext.fcntl.FcntlLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"rubinius.jar"</span>, <span style="color: #ffa07a;">"rubinius"</span>, <span style="color: #ffa07a;">"org.jruby.ext.rubinius.RubiniusLibrary"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"yecht.jar"</span>, <span style="color: #ffa07a;">"yecht"</span>, <span style="color: #ffa07a;">"YechtService"</span>);
addLazyBuiltin(<span style="color: #ffa07a;">"io/try_nonblock.jar"</span>, <span style="color: #ffa07a;">"io/try_nonblock"</span>, <span style="color: #ffa07a;">"org.jruby.ext.io.try_nonblock.IOTryNonblockLibrary"</span>);
<span style="color: #00ffff;">if</span> (is1_9()) {
    addLazyBuiltin(<span style="color: #ffa07a;">"mathn/complex.jar"</span>, <span style="color: #ffa07a;">"mathn/complex"</span>, <span style="color: #ffa07a;">"org.jruby.ext.mathn.Complex"</span>);
    addLazyBuiltin(<span style="color: #ffa07a;">"mathn/rational.jar"</span>, <span style="color: #ffa07a;">"mathn/rational"</span>, <span style="color: #ffa07a;">"org.jruby.ext.mathn.Rational"</span>);
    addLazyBuiltin(<span style="color: #ffa07a;">"fiber.rb"</span>, <span style="color: #ffa07a;">"fiber"</span>, <span style="color: #ffa07a;">"org.jruby.ext.fiber.FiberExtLibrary"</span>);
    addLazyBuiltin(<span style="color: #ffa07a;">"psych.jar"</span>, <span style="color: #ffa07a;">"psych"</span>, <span style="color: #ffa07a;">"org.jruby.ext.psych.PsychLibrary"</span>);
    addLazyBuiltin(<span style="color: #ffa07a;">"coverage.jar"</span>, <span style="color: #ffa07a;">"coverage"</span>, <span style="color: #ffa07a;">"org.jruby.ext.coverage.CoverageLibrary"</span>);
</pre>
</div>

<p>
Tracing back along the load chain, <code>org.jruby.runtime.load.LoadService#addBuiltinLibrary</code> -&gt; <code>org.jruby.runtime.load.Library#load</code> <br/>
<code>Library#load</code> is an interface and <code>LoadService</code> implemented it:
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #00ffff;">public</span> <span style="color: #98fb98;">void</span> <span style="color: #87cefa;">load</span>(<span style="color: #98fb98;">String</span> <span style="color: #eedd82;">file</span>, <span style="color: #98fb98;">boolean</span> <span style="color: #eedd82;">wrap</span>) {
    <span style="color: #98fb98;">long</span> <span style="color: #eedd82;">startTime</span> = loadTimer.startLoad(file);
    <span style="color: #00ffff;">try</span> {
        <span style="color: #00ffff;">if</span>(!runtime.getProfile().allowLoad(file)) {
            <span style="color: #00ffff;">throw</span> runtime.newLoadError(<span style="color: #ffa07a;">"no such file to load -- "</span> + file, file);
        }

        <span style="color: #98fb98;">SearchState</span> <span style="color: #eedd82;">state</span> = <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">SearchState</span>(file);
        state.prepareLoadSearch(file);

        <span style="color: #98fb98;">Library</span> <span style="color: #eedd82;">library</span> = findBuiltinLibrary(state, state.searchFile, state.suffixType);
        <span style="color: #00ffff;">if</span> (library == <span style="color: #7fffd4;">null</span>) library = findLibraryWithoutCWD(state, state.searchFile, state.suffixType);

        <span style="color: #00ffff;">if</span> (library == <span style="color: #7fffd4;">null</span>) {
            library = findLibraryWithClassloaders(state, state.searchFile, state.suffixType);
            <span style="color: #00ffff;">if</span> (library == <span style="color: #7fffd4;">null</span>) {
                <span style="color: #00ffff;">throw</span> runtime.newLoadError(<span style="color: #ffa07a;">"no such file to load -- "</span> + file, file);
            }
        }
        <span style="color: #00ffff;">try</span> {
            library.load(runtime, wrap);
        } <span style="color: #00ffff;">catch</span> (<span style="color: #98fb98;">IOException</span> <span style="color: #eedd82;">e</span>) {
            <span style="color: #00ffff;">if</span> (runtime.getDebug().isTrue()) e.printStackTrace(runtime.getErr());
            <span style="color: #00ffff;">throw</span> newLoadErrorFromThrowable(runtime, file, e);
        }
    } <span style="color: #00ffff;">finally</span> {
        loadTimer.endLoad(file, startTime);
    }
}
</pre>
</div>
<p>
It seems that JRuby has a loadTimer but without displaying library loadtime in default. I'm going to find how to get the loadtime of every library and decide which could be reduced or just optimized.
</p>
</div>
</li></ol>
</li></ol>
</li></ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2013-06-19 Wed 09:08</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.0.3)</p>
<p class="xhtml-validation"><a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a></p>
</div>
</body>
</html>
